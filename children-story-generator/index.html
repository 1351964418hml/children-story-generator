<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªæ€§åŒ–å„¿ç«¥æ•…äº‹ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap');
        
        body {
            font-family: 'Comic Neue', cursive;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .story-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(0, 0, 0, 0.1);
        }
        
        .loading {
            display: none;
        }
        
        .story-content {
            line-height: 1.8;
            font-size: 1.1rem;
        }
        
        .illustration-img {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            border-radius: 10px;
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="py-8 px-4">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-purple-800 mb-4">âœ¨ ä¸ªæ€§åŒ–å„¿ç«¥æ•…äº‹ç”Ÿæˆå™¨ âœ¨</h1>
            <p class="text-xl text-gray-600">åˆ›é€ å±äºæ‚¨å­©å­çš„ä¸“å±ç«¥è¯æ•…äº‹</p>
        </header>

        <div class="story-container p-8 mb-8">
            <form id="storyForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-gray-700 mb-2 font-medium" for="childName">å­©å­å§“å</label>
                    <input type="text" id="childName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="è¯·è¾“å…¥å­©å­çš„åå­—" required>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2 font-medium" for="childAge">å­©å­å¹´é¾„</label>
                    <input type="number" id="childAge" min="3" max="12" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="3-12å²" required>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2 font-medium">å­©å­æ€§åˆ«</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="gender" value="ç”·å­©" class="h-5 w-5 text-purple-600" checked>
                            <span class="ml-2 text-gray-700">ç”·å­©</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="gender" value="å¥³å­©" class="h-5 w-5 text-purple-600">
                            <span class="ml-2 text-gray-700">å¥³å­©</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2 font-medium" for="characterType">å–œæ¬¢çš„ä¸»è§’ç±»å‹</label>
                    <select id="characterType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <option value="å°å…¬ä¸»">å°å…¬ä¸»</option>
                        <option value="å°éª‘å£«">å°éª‘å£«</option>
                        <option value="å°æé¾™">å°æé¾™</option>
                        <option value="å°çŒ«">å°çŒ«</option>
                        <option value="å°æœºå™¨äºº">å°æœºå™¨äºº</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2 font-medium" for="theme">æ•…äº‹ä¸»é¢˜</label>
                    <select id="theme" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <option value="å‹‡æ•¢å†’é™©">å‹‡æ•¢å†’é™©</option>
                        <option value="å‹è°Š">å‹è°Š</option>
                        <option value="ç¯ä¿">ç¯ä¿</option>
                        <option value="æ¢ç´¢å¤ªç©º">æ¢ç´¢å¤ªç©º</option>
                        <option value="å­¦ä¼šåˆ†äº«">å­¦ä¼šåˆ†äº«</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2 font-medium" for="setting">æ•…äº‹åœºæ™¯</label>
                    <select id="setting" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <option value="é­”æ³•æ£®æ—">é­”æ³•æ£®æ—</option>
                        <option value="æœªæ¥åŸå¸‚">æœªæ¥åŸå¸‚</option>
                        <option value="æµ·åº•ä¸–ç•Œ">æµ·åº•ä¸–ç•Œ</option>
                        <option value="æœˆçƒ">æœˆçƒ</option>
                        <option value="ç«¥è¯ç‹å›½">ç«¥è¯ç‹å›½</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-gray-700 mb-2 font-medium" for="moral">ä¼ é€’çš„ä»·å€¼è§‚/æ•™è‚²æ„ä¹‰ (å¯é€‰)</label>
                    <textarea id="moral" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" rows="2" placeholder="ä¾‹å¦‚ï¼šå‹‡æ•¢é¢å¯¹å›°éš¾ã€çæƒœå‹è°Šã€ä¿æŠ¤ç¯å¢ƒ..."></textarea>
                </div>
                
                <div class="md:col-span-2 text-center">
                    <button type="submit" class="btn-primary text-white font-bold py-3 px-8 rounded-lg text-lg">
                        <i class="fas fa-magic mr-2"></i>ç”Ÿæˆä¸“å±æ•…äº‹
                    </button>
                </div>
            </form>
        </div>

        <div class="loading text-center py-12">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-600"></div>
            <p class="mt-4 text-gray-600">æ­£åœ¨åˆ›ä½œç²¾å½©æ•…äº‹ä¸­ï¼Œè¯·ç¨å€™...</p>
        </div>

        <div id="result" class="story-container p-8 hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-800">æ‚¨çš„ä¸“å±æ•…äº‹</h2>
                <button id="speakBtn" class="bg-purple-100 text-purple-700 py-2 px-4 rounded-lg hover:bg-purple-200 transition">
                    <i class="fas fa-volume-up mr-2"></i>æœ—è¯»æ•…äº‹
                </button>
            </div>
            
            <div class="story-content mb-8 text-gray-700" id="storyText"></div>
            
            <div class="mb-6">
                <h3 class="text-xl font-bold text-purple-700 mb-4">æ•…äº‹æ’å›¾</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="illustrations"></div>
            </div>
            
            <div class="text-center">
                <button id="newStoryBtn" class="btn-primary text-white font-bold py-3 px-8 rounded-lg text-lg">
                    <i class="fas fa-plus mr-2"></i>åˆ›ä½œæ–°æ•…äº‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // çœŸå®çš„APIè°ƒç”¨å‡½æ•°
        async function generateStory(formData) {
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }

                // æ˜¾ç¤ºæ•…äº‹å†…å®¹
                let storyHTML = '';
                if (typeof result.story === 'string') {
                    // å¦‚æœæ•…äº‹æ˜¯çº¯æ–‡æœ¬ï¼ŒæŒ‰æ®µè½åˆ†å‰²
                    storyHTML = result.story.split('\n')
                        .filter(para => para.trim())
                        .map(paragraph => `<p class="mb-4">${paragraph}</p>`)
                        .join('');
                } else {
                    // å¤‡ç”¨æ•…äº‹å†…å®¹
                    storyHTML = `
                        <p class="mb-4">åœ¨é¥è¿œçš„${formData.setting}é‡Œï¼Œä½ç€ä¸€ä½åå«${formData.childName}çš„${formData.characterType}ã€‚</p>
                        <p class="mb-4">${formData.childName}æ˜¯ä¸€ä¸ªå……æ»¡å¥½å¥‡å¿ƒçš„${formData.gender}ï¼Œæ€»æ˜¯æ¢¦æƒ³ç€æ¢ç´¢ä¸–ç•Œçš„æ¯ä¸€ä¸ªè§’è½ã€‚</p>
                        <p class="mb-4">ä¸€å¤©ï¼Œ${formData.childName}å‘ç°äº†ä¸€ä¸ªç¥ç§˜çš„å®è—åœ°å›¾ï¼Œå†³å®šè¸ä¸Šå¯»æ‰¾å®è—çš„æ—…ç¨‹ã€‚</p>
                        <p class="mb-4">åœ¨æ—…é€”ä¸­ï¼Œ${formData.childName}é‡åˆ°äº†è®¸å¤šæŒ‘æˆ˜ï¼Œä½†å‡­å€Ÿå‹‡æ°”å’Œæ™ºæ…§éƒ½ä¸€ä¸€å…‹æœäº†ã€‚</p>
                        <p class="mb-4">æœ€ç»ˆï¼Œ${formData.childName}æ˜ç™½äº†${formData.theme}çš„çœŸæ­£æ„ä¹‰ï¼Œå¸¦ç€å®è´µçš„ç»éªŒå›åˆ°äº†å®¶ã€‚</p>
                        <p class="font-bold text-purple-700">${formData.moral || 'è¿™ä¸ªæ•…äº‹å‘Šè¯‰æˆ‘ä»¬ï¼Œå‹‡æ•¢é¢å¯¹æŒ‘æˆ˜ã€å¸®åŠ©ä»–äººï¼Œæˆ‘ä»¬ä¼šå‘ç°ç”Ÿæ´»ä¸­æœ€çè´µçš„å®è—ã€‚'}</p>
                    `;
                }
                
                document.getElementById('storyText').innerHTML = storyHTML;
                
                // æ˜¾ç¤ºæ’å›¾
                const illustrationsContainer = document.getElementById('illustrations');
                illustrationsContainer.innerHTML = '';
                
                const illustrations = result.illustration_prompts || [
                    `${formData.childName}ä½œä¸º${formData.characterType}åœ¨${formData.setting}ä¸­å¼€å§‹å†’é™©`,
                    `${formData.childName}ç”¨æ™ºæ…§å’Œå‹‡æ°”å…‹æœæ—…é€”ä¸­çš„å›°éš¾`, 
                    `${formData.childName}ä¸æœ‹å‹ä»¬ä¸€èµ·åº†ç¥æˆåŠŸ`
                ];
                
                const emojis = ["ğŸ—ºï¸", "ğŸŒŠ", "ğŸ‰"];
                illustrations.forEach((prompt, index) => {
                    const illustrationElement = document.createElement('div');
                    illustrationElement.className = 'bg-white rounded-xl shadow-md overflow-hidden border border-gray-200';
                    illustrationElement.innerHTML = `
                        <div class="illustration-img h-48">
                            <span class="text-4xl">${emojis[index]}</span>
                        </div>
                        <div class="p-4">
                            <h4 class="font-bold text-purple-700 mb-2">æ’å›¾ ${index + 1}</h4>
                            <p class="text-sm text-gray-600">${prompt}</p>
                            <div class="mt-3 text-xs text-purple-500">
                                <i class="fas fa-paint-brush mr-1"></i>AIç”Ÿæˆæç¤º
                            </div>
                        </div>
                    `;
                    illustrationsContainer.appendChild(illustrationElement);
                });
                
                // éšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºç»“æœ
                document.querySelector('.loading').style.display = 'none';
                document.getElementById('result').classList.remove('hidden');
                
            } catch (error) {
                console.error('ç”Ÿæˆæ•…äº‹é”™è¯¯:', error);
                document.querySelector('.loading').style.display = 'none';
                alert('ç”Ÿæˆæ•…äº‹å¤±è´¥: ' + error.message);
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('storyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            document.querySelector('.loading').style.display = 'block';
            document.getElementById('result').classList.add('hidden');
            
            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = {
                childName: document.getElementById('childName').value,
                childAge: document.getElementById('childAge').value,
                gender: document.querySelector('input[name="gender"]:checked').value,
                characterType: document.getElementById('characterType').value,
                theme: document.getElementById('theme').value,
                setting: document.getElementById('setting').value,
                moral: document.getElementById('moral').value
            };
            
            // è°ƒç”¨APIç”Ÿæˆæ•…äº‹
            generateStory(formData);
        });
        
        document.getElementById('newStoryBtn').addEventListener('click', function() {
            document.getElementById('result').classList.add('hidden');
            document.getElementById('storyForm').reset();
        });
        
        document.getElementById('speakBtn').addEventListener('click', function() {
            const storyText = document.getElementById('storyText').innerText;
            speakText(storyText);
        });
        
        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                const speech = new SpeechSynthesisUtterance();
                speech.text = text;
                speech.lang = 'zh-CN';
                speech.rate = 0.9;
                speech.pitch = 1.2;
                
                window.speechSynthesis.speak(speech);
            } else {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Edgeæˆ–Safariæµè§ˆå™¨ã€‚');
            }
        }
    </script>
</body>
</html>